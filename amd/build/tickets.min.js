define(["jquery","core/notification","core/str","core/ajax","block_ludifica/alertc","block_ludifica/player","core/modal_factory","core/log"],function(a,c,t,o,n,f,k,l){var d=[],u=null;function r(t){var e=a("<div></div>"),i=a('<select id="block_ludifica_ticket_given_contact" class="form-control"></select>');e.append("<h4>"+d.giveticketmessage+"</h4>"),u.forEach(e=>{i.append('<option value="'+e.id+'">'+e.name+"</option>")}),e.append(i),c.confirm(d.giveticket,e.html(),d.give,d.cancel,function(){var e=parseInt(a("#block_ludifica_ticket_given_contact").val());o.call([{methodname:"block_ludifica_give_ticket",args:{ticketid:t,contactid:e},done:function(e){e?(n.success(d.given),s(t)):n.error(d.notgive)},fail:function(e){n.error(e.message),l.debug(e)}}])})}function s(n){o.call([{methodname:"block_ludifica_get_ticket",args:{id:n},done:function(e){var t,i,c,o;e&&"object"==typeof e&&(t=a("#ticket-"+n),i=a("#moreinfo-ticket-content-"+n+" .usertickets"),c=i.find("ul"),o=0,t.find('val[key="available"]').html(e.available),t.find('val[key="usertickets"]').html(e.usertickets.length),c.empty(),0<e.usertickets.length?(t.find('[data-action="give"]').show(),i.show(),e.usertickets.forEach(e=>{var t=a('<li class="list-group-item"></li>'),i=a('<span class="usercode">'+e.usercode+" </span>");t.append(i),e.timeused&&(i.addClass("usercode-used"),i=d.usedat.replace("USERDATE",e.timeusedformatted),i=a("<em> "+i+"</em>"),t.append(i)),c.append(t),e.timeused||o++})):i.hide(),0==o&&t.find('[data-action="give"]').hide(),e.available<=0||e.byuser<=e.usertickets.length?t.find('[data-action="buy"]').hide():t.find('[data-action="buy"]').show())},fail:function(e){l.debug(e)}}])}return{init:function(e){var i=[{key:"buyticket",component:"block_ludifica"},{key:"buyticketmessage",component:"block_ludifica"},{key:"buy",component:"block_ludifica"},{key:"notbuy",component:"block_ludifica"},{key:"give",component:"block_ludifica"},{key:"given",component:"block_ludifica"},{key:"notgive",component:"block_ludifica"},{key:"giveticket",component:"block_ludifica"},{key:"giveticketmessage",component:"block_ludifica"},{key:"notcontacts",component:"block_ludifica"},{key:"bought",component:"block_ludifica"},{key:"usedat",component:"block_ludifica",param:"USERDATE"},{key:"cancel"},{key:"continue"},{key:"error"},{key:"info"}];i.forEach(function(e){d[e.key]=e.key}),t.get_strings(i).then(function(e){return e.forEach(function(e,t){d[i[t].key]=e}),!0}).fail(function(e){l.debug("Error loading strings"),l.debug(e)}),a('[data-action="buy"]').on("click",function(){var t=a(this).data("id");c.confirm(d.buyticket,d.buyticketmessage,d.buy,d.cancel,function(){o.call([{methodname:"block_ludifica_buy_ticket",args:{id:t},done:function(e){e?(n.success(d.bought),s(t),f.reloadStats()):n.error(d.notbuy)},fail:function(e){l.debug("Error buy ticket"),l.debug(e)}}])})}),a('[data-action="give"]').on("click",function(){var t=a(this).data("id");u?r(t):o.call([{methodname:"core_message_get_user_contacts",args:{userid:e},done:function(e){e&&"object"==typeof e&&0<e.length?(u=[],e.forEach(e=>{e.isdeleted||e.isblocked||!e.iscontact||u.push({name:e.fullname,id:e.id})}),r(t)):n.warning(d.notcontacts)},fail:function(e){n.error(e.message),l.debug(e)}}])}),a('[data-action="showmore"]').on("click",function(){var e=a(this).data("id"),e=a("#moreinfo-ticket-"+e),e={title:e.attr("title"),body:e.html()};k.create(e).then(function(e){return e.show(),!0}).fail(function(e){l.debug("Error creating modal showmore"),l.debug(e)})})}}});
//# sourceMappingURL=tickets.min.js.map