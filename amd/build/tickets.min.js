function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)
/**
 * Javascript to tickets manage.
 *
 * @module    block/ludifica
 * @copyright 2021 David Herney @ BambuCo
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */}define("block_ludifica/tickets",["jquery","core/notification","core/str","core/ajax","block_ludifica/alertc","block_ludifica/player","core/modal_factory","core/log"],(function($,Notification,Str,Ajax,Alertc,Player,ModalFactory,Log){var s=[],contacts=null;function giveView(ticketid){var $content=$("<div></div>"),$contactslist=$('<select id="block_ludifica_ticket_given_contact" class="form-control"></select>');$content.append("<h4>"+s.giveticketmessage+"</h4>"),contacts.forEach((function(contact){$contactslist.append('<option value="'+contact.id+'">'+contact.name+"</option>")})),$content.append($contactslist),Notification.confirm(s.giveticket,$content.html(),s.give,s.cancel,(function(){var contactid=parseInt($("#block_ludifica_ticket_given_contact").val());Ajax.call([{methodname:"block_ludifica_give_ticket",args:{ticketid:ticketid,contactid:contactid},done:function(data){data?(Alertc.success(s.given),updateTicketData(ticketid)):Alertc.error(s.notgive)},fail:function(e){Alertc.error(e.message),Log.debug(e)}}])}))}function updateTicketData(ticketid){Ajax.call([{methodname:"block_ludifica_get_ticket",args:{id:ticketid},done:function(data){if(data&&"object"==_typeof(data)){var $ticket=$("#ticket-"+ticketid),$usertickets=$("#moreinfo-ticket-content-"+ticketid+" .usertickets"),$userticketslist=$usertickets.find("ul"),userticketsavailable=0;$ticket.find('val[key="available"]').html(data.available),$ticket.find('val[key="usertickets"]').html(data.usertickets.length),$userticketslist.empty(),data.usertickets.length>0?($ticket.find('[data-action="give"]').show(),$usertickets.show(),data.usertickets.forEach((function(one){var $tplitem=$('<li class="list-group-item"></li>'),$tplusercode=$('<span class="usercode">'+one.usercode+" </span>");if($tplitem.append($tplusercode),one.timeused){$tplusercode.addClass("usercode-used");var userdate=s.usedat.replace("USERDATE",one.timeusedformatted),$tpltimeused=$("<em> "+userdate+"</em>");$tplitem.append($tpltimeused)}$userticketslist.append($tplitem),one.timeused||userticketsavailable++}))):$usertickets.hide(),0==userticketsavailable&&$ticket.find('[data-action="give"]').hide(),data.available<=0||data.byuser<=data.usertickets.length?$ticket.find('[data-action="buy"]').hide():$ticket.find('[data-action="buy"]').show()}},fail:function(e){Log.debug(e)}}])}return{init:function(userid){var strings=[{key:"buyticket",component:"block_ludifica"},{key:"buyticketmessage",component:"block_ludifica"},{key:"buy",component:"block_ludifica"},{key:"notbuy",component:"block_ludifica"},{key:"give",component:"block_ludifica"},{key:"given",component:"block_ludifica"},{key:"notgive",component:"block_ludifica"},{key:"giveticket",component:"block_ludifica"},{key:"giveticketmessage",component:"block_ludifica"},{key:"notcontacts",component:"block_ludifica"},{key:"bought",component:"block_ludifica"},{key:"usedat",component:"block_ludifica",param:"USERDATE"},{key:"cancel"},{key:"continue"},{key:"error"},{key:"info"}];strings.forEach((function(one){s[one.key]=one.key})),Str.get_strings(strings).then((function(results){return results.forEach((function(value,index){s[strings[index].key]=value})).fail((function(e){Log.debug("Error loading strings"),Log.debug(e)})),!0})),$('[data-action="buy"]').on("click",(function(){var ticketid=$(this).data("id");Notification.confirm(s.buyticket,s.buyticketmessage,s.buy,s.cancel,(function(){Ajax.call([{methodname:"block_ludifica_buy_ticket",args:{id:ticketid},done:function(data){data?(Alertc.success(s.bought),updateTicketData(ticketid),Player.reloadStats()):Alertc.error(s.notbuy)},fail:function(e){Log.debug("Error buy ticket"),Log.debug(e)}}])}))})),$('[data-action="give"]').on("click",(function(){var ticketid=$(this).data("id");contacts?giveView(ticketid):Ajax.call([{methodname:"core_message_get_user_contacts",args:{userid:userid},done:function(data){data&&"object"==_typeof(data)&&data.length>0?(contacts=[],data.forEach((function(contact){contact.isdeleted||contact.isblocked||!contact.iscontact||contacts.push({name:contact.fullname,id:contact.id})})),giveView(ticketid)):Alertc.warning(s.notcontacts)},fail:function(e){Alertc.error(e.message),Log.debug(e)}}])})),$('[data-action="showmore"]').on("click",(function(){var ticketid=$(this).data("id"),$more=$("#moreinfo-ticket-"+ticketid),props={title:$more.attr("title"),body:$more.html()};ModalFactory.create(props).then((function(modal){return modal.show(),!0})).fail((function(e){Log.debug("Error creating modal showmore"),Log.debug(e)}))}))}}}));

//# sourceMappingURL=tickets.min.js.map